{% extends 'base.html' %}
{% load crispy_forms_tags %}

{% block title %}
{% if section %}
<title> Ransack | Round Prelims</title>
{% else %}
<title> Ransack | Round Finals</title>
{% endif %}
{% endblock %}

{% block content %}
<!-- Section A -->
{% if page.object_list %}
<h2>Section A</h2>

{% for question in page.object_list %}

{% for q in question.images.all %}
<img src="{{ q.image.url }}" alt="img" width="250" />
{% endfor %}

<form method="POST" data-id="{{question.id}}">
    {% csrf_token %}
    {{ answer_form|crispy }}
    <!--If you don't put type attribute it will take it as submit type by default and refreshes the form-->
    <button type="button" class="btn btn-success float-right submit_button"
        data-question="{{question.id}}">Submit</button>
    {% if page.has_next %}
        <a href="?page={{page.next_page_number}}" class="btn btn-primary float-right next"
            style="pointer-events:none ; cursor:default">Next</a>
    {% else %}
        {% if section %}
            <a href="{% url 'wordhunt:prelimsB' %}"
                class="btn btn-disabled text-white bg-pink-500 hover:bg-pink-600 focus:ring-4 focus:ring-indigo-300 px-4 m-2  float-right next"
                style="pointer-events:none ; cursor:default">Next</a>
        {% else %}
            <a href="{% url 'wordhunt:finalsB' %}"
                class="btn btn-disabled text-white bg-pink-500 hover:bg-pink-600 focus:ring-4 focus:ring-indigo-300 px-4 m-2  float-right next"
                style="pointer-events:none ; cursor:default">Next</a>
        {% endif %}
    {% endif %}
</form>

{% endfor %}
<h2>{{page}}</h2>
{% else %}
<h1> There might be some problem </h1>
{% endif %}


{% endblock %}

{% block script %}
<script>
    $(document).ready(function () {

        var count = 0, round;
        {% if section %}
        // Prelims
        round = "prelims";
        {% else %}
        // Finals
        round = "finals";
        {% endif %}

        $(window).focus(function () {
            count = count + 1
            if (count === 1) {
                alert("Tab Switching is not Allowed more than 2 times.\nTab Switch Count: 1");
            }
            else if (count === 2) {
                alert("Tab Switching is not Allowed more than 2 times.\nTab Switch Count: 2");
            }
            else {
                alert("Malpractice");
                $.ajax({
                    headers: {
                        "X-CSRFTOKEN": "{{ csrf_token }}",
                        'contentType': 'application/json;charset=utf-8',
                    },
                    url: "{% url 'wordhunt:exit_test' %}",
                    type: 'post',
                    data: { 'round': round },
                    dataType: 'json',
                    success: function (data) {
                        if (data.is_taken) {
                            location.reload();
                        }
                    }
                });
            }
        });

        $(".submit_button").click(function () {
            // Answer 
            var answer = $(this).parent().find("#id_user_answer").val();
            // Question id
            var question_id = $(this).attr('data-question');
            if (answer.length == 0) {
                alert("Please fill the answer otherwise you can't go to the next page")
            }
            else {

                $.ajax({
                    headers: {
                        "X-CSRFTOKEN": "{{ csrf_token }}",
                        'contentType': 'application/json;charset=utf-8',
                    },
                    url: "{% url 'wordhunt:answer_submit_prelims' %}",
                    type: 'post',
                    data: { 'answer': answer, 'question_id': question_id ,'round':round},
                    dataType: 'json',
                    success: function (data) {
                        if (data['is_taken']) {
                            alert("already submitted");
                            $(".next").removeAttr("style");
                        }
                        else if(data['failure']){
                            alert('Time is over')
                            $(".next").removeAttr("style")
                        }
                        else if(data['status']=='cheated')
                        {
                            alert('Malpractice has been detected for you')
                            $(".next").removeAttr("style")
                        }
                        else {
                            alert("Submitted successfully");
                            $(".next").removeAttr("style");
                        }
                    }
                });
            }
        });
    });
</script>

{% endblock %}